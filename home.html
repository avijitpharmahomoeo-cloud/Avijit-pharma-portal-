<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Avijit Pharma | Pro Stock Manager</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f1f5f9; -webkit-tap-highlight-color: transparent; }
        .glass-card { background: rgba(255, 255, 255, 1); border: 1px solid rgba(226, 232, 240, 1); }
        .premium-shadow { box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1); }
        
        .low-stock-pulse { animation: pulse-red 2s infinite; color: #ef4444; font-weight: 700; }
        @keyframes pulse-red {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        input, select, textarea { font-size: 16px !important; }

        @media (max-width: 768px) {
            .mobile-hide { display: none; }
        }

        #sideMenu {
            transition: transform 0.3s ease-in-out;
            transform: translateX(100%);
        }
        #sideMenu.open {
            transform: translateX(0);
        }

        .search-results-container {
            max-height: 200px;
            overflow-y: auto;
            z-index: 100;
        }
        .search-result-item {
            cursor: pointer;
            transition: background 0.2s;
        }
        .search-result-item:hover {
            background-color: #f1f5f9;
        }
    </style>
</head>
<body class="text-slate-900 pb-24 md:pb-0">

    <!-- Navbar -->
    <nav class="sticky top-0 z-50 bg-white border-b border-slate-200 premium-shadow">
        <div class="max-w-7xl mx-auto px-4">
            <div class="flex items-center justify-between h-16">
                <div class="flex items-center gap-2">
                    <div class="bg-blue-600 p-2 rounded-lg text-white">
                        <i class="fas fa-prescription"></i>
                    </div>
                    <span class="text-xl font-bold tracking-tight">Avijit <span class="text-blue-600">Pharma</span></span>
                </div>
                
                <div class="flex items-center gap-1 md:gap-3">
                    <div class="relative cursor-pointer p-2" id="notifBell">
                        <i class="fas fa-bell text-xl text-slate-400"></i>
                        <span id="notifBadge" class="hidden absolute top-1 right-1 bg-red-500 text-white text-[10px] w-4 h-4 rounded-full flex items-center justify-center font-bold border-2 border-white">0</span>
                    </div>

                    <button onclick="toggleSideMenu(true)" class="p-2 text-slate-500 hover:text-blue-600 transition-colors">
                        <i class="fas fa-bars text-xl"></i>
                    </button>

                    <div class="hidden lg:flex gap-2 ml-2">
                        <button onclick="openModal('medicineModal')" class="bg-blue-600 text-white px-4 py-2 rounded-lg text-sm font-semibold hover:bg-blue-700 transition-all">
                            <i class="fas fa-plus mr-1"></i> Add Stock
                        </button>
                        <button onclick="openModal('salesModal')" class="bg-slate-900 text-white px-4 py-2 rounded-lg text-sm font-semibold hover:bg-slate-800 transition-all">
                            <i class="fas fa-shopping-cart mr-1"></i> New Sale
                        </button>
                    </div>
                </div>
            </div>

            <!-- Filters Area -->
            <div class="pb-4 flex flex-col md:flex-row gap-3">
                <div class="relative flex-1">
                    <i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-slate-400"></i>
                    <input type="text" id="searchInput" placeholder="Search medicines in stock..." 
                        class="w-full pl-10 pr-4 py-2.5 bg-slate-100 border-none rounded-xl focus:ring-2 focus:ring-blue-500 transition-all outline-none text-sm">
                </div>
                <div class="flex gap-2">
                    <select id="categoryFilter" class="flex-1 md:w-48 bg-slate-100 border-none rounded-xl px-4 py-2.5 text-sm focus:ring-2 focus:ring-blue-500 outline-none cursor-pointer font-medium text-slate-600">
                        <option value="All">All Categories</option>
                        <option>Mother Tincture</option>
                        <option>Dilution</option>
                        <option>Trituration</option>
                        <option>Biochemic</option>
                        <option>Patent</option>
                        <option>Liquid</option>
                    </select>
                </div>
            </div>
        </div>
    </nav>

    <!-- Side Navigation Menu -->
    <div id="sideMenuOverlay" class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-[100] hidden transition-opacity" onclick="toggleSideMenu(false)"></div>
    <div id="sideMenu" class="fixed top-0 right-0 h-full w-72 bg-white z-[101] shadow-2xl flex flex-col">
        <div class="p-6 border-b border-slate-100 flex items-center justify-between bg-blue-600 text-white">
            <h3 class="font-bold text-lg">Main Menu</h3>
            <button onclick="toggleSideMenu(false)" class="w-8 h-8 rounded-full hover:bg-white/20 flex items-center justify-center">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="flex-1 overflow-y-auto p-4 space-y-1">
            <a href="sales.html" class="flex items-center gap-3 p-3.5 rounded-xl hover:bg-blue-50 text-slate-700 hover:text-blue-600 font-medium transition-all group">
                <div class="w-10 h-10 bg-slate-100 rounded-lg flex items-center justify-center group-hover:bg-blue-100 transition-colors"><i class="fas fa-chart-line"></i></div>
                <span>Sales Report</span>
            </a>
            <a href="patient.html" class="flex items-center gap-3 p-3.5 rounded-xl hover:bg-blue-50 text-slate-700 hover:text-blue-600 font-medium transition-all group">
                <div class="w-10 h-10 bg-slate-100 rounded-lg flex items-center justify-center group-hover:bg-blue-100 transition-colors"><i class="fas fa-hospital-user"></i></div>
                <span>Patient Portal</span>
            </a>
            <a href="prescribe.html" class="flex items-center gap-3 p-3.5 rounded-xl hover:bg-blue-50 text-slate-700 hover:text-blue-600 font-medium transition-all group">
                <div class="w-10 h-10 bg-slate-100 rounded-lg flex items-center justify-center group-hover:bg-blue-100 transition-colors"><i class="fas fa-file-medical"></i></div>
                <span>View New Prescribe</span>
            </a>
            <a href="portal.html" class="flex items-center gap-3 p-3.5 rounded-xl hover:bg-blue-50 text-slate-700 hover:text-blue-600 font-medium transition-all group">
                <div class="w-10 h-10 bg-slate-100 rounded-lg flex items-center justify-center group-hover:bg-blue-100 transition-colors"><i class="fas fa-desktop"></i></div>
                <span>Edit Portal</span>
            </a>
            <a href="invoice.html" class="flex items-center gap-3 p-3.5 rounded-xl hover:bg-blue-50 text-slate-700 hover:text-blue-600 font-medium transition-all group">
                <div class="w-10 h-10 bg-slate-100 rounded-lg flex items-center justify-center group-hover:bg-blue-100 transition-colors"><i class="fas fa-file-invoice-dollar"></i></div>
                <span>Invoice Generator</span>
            </a>
            <a href="appointment.html" class="flex items-center gap-3 p-3.5 rounded-xl hover:bg-blue-50 text-slate-700 hover:text-blue-600 font-medium transition-all group">
                <div class="w-10 h-10 bg-slate-100 rounded-lg flex items-center justify-center group-hover:bg-blue-100 transition-colors"><i class="fas fa-calendar-check"></i></div>
                <span>View Appointment</span>
            </a>
            <a href="doctor.html" class="flex items-center gap-3 p-3.5 rounded-xl hover:bg-blue-50 text-slate-700 hover:text-blue-600 font-medium transition-all group">
                <div class="w-10 h-10 bg-slate-100 rounded-lg flex items-center justify-center group-hover:bg-blue-100 transition-colors"><i class="fas fa-user-md"></i></div>
                <span>Add Doctor</span>
            </a>
            <a href="other.html" class="flex items-center gap-3 p-3.5 rounded-xl hover:bg-blue-50 text-slate-700 hover:text-blue-600 font-medium transition-all group">
                <div class="w-10 h-10 bg-slate-100 rounded-lg flex items-center justify-center group-hover:bg-blue-100 transition-colors"><i class="fas fa-cog"></i></div>
                <span>Other Edit</span>
            </a>
            <a href="support.html" class="flex items-center gap-3 p-3.5 rounded-xl hover:bg-blue-50 text-slate-700 hover:text-blue-600 font-medium transition-all group">
                <div class="w-10 h-10 bg-slate-100 rounded-lg flex items-center justify-center group-hover:bg-blue-100 transition-colors"><i class="fas fa-headset"></i></div>
                <span>Support</span>
            </a>
        </div>
        <div class="p-6 border-t border-slate-100 text-center">
            <p class="text-[10px] text-slate-400 font-bold uppercase tracking-widest">Avijit Pharma v2.9</p>
        </div>
    </div>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto p-4 md:p-6">
        <!-- ALERTS -->
        <div id="alertBanner" class="hidden mb-6 space-y-3">
            <div class="bg-red-50 border border-red-100 rounded-2xl p-4 md:p-5">
                <div class="flex items-center gap-3 mb-3">
                    <div class="w-8 h-8 bg-red-600 text-white rounded-full flex items-center justify-center low-stock-pulse"><i class="fas fa-bell text-sm"></i></div>
                    <h3 class="text-red-900 font-bold">Critical Alerts</h3>
                </div>
                <div id="alertItemsList" class="flex flex-wrap gap-2"></div>
            </div>
        </div>

        <!-- Dashboard Stats -->
        <div class="grid grid-cols-1 sm:grid-cols-4 gap-4 mb-8">
            <div class="glass-card p-4 rounded-2xl border-l-4 border-blue-600">
                <p class="text-slate-500 text-[10px] font-bold uppercase tracking-widest">Medicines</p>
                <h2 id="totalMeds" class="text-2xl font-bold mt-1">0</h2>
            </div>
            <div class="glass-card p-4 rounded-2xl border-l-4 border-emerald-500">
                <p class="text-slate-500 text-[10px] font-bold uppercase tracking-widest">Stock Value</p>
                <h2 id="totalValue" class="text-2xl font-bold mt-1 text-emerald-600">₹0.00</h2>
            </div>
            <div class="glass-card p-4 rounded-2xl border-l-4 border-orange-500">
                <p class="text-slate-500 text-[10px] font-bold uppercase tracking-widest">Low Stock</p>
                <h2 id="lowStockCount" class="text-2xl font-bold mt-1 text-orange-600">0</h2>
            </div>
            <div class="glass-card p-4 rounded-2xl border-l-4 border-red-600">
                <p class="text-slate-500 text-[10px] font-bold uppercase tracking-widest">Expiring</p>
                <h2 id="expiryAlertCount" class="text-2xl font-bold mt-1 text-red-600">0</h2>
            </div>
        </div>

        <!-- Inventory List -->
        <div class="mb-4 flex justify-between items-center">
            <h3 class="text-lg font-bold text-slate-800">Medicine Inventory</h3>
            <span id="resultCount" class="text-xs font-bold text-slate-400 bg-slate-200 px-3 py-1 rounded-full">0 items</span>
        </div>

        <div class="hidden md:block glass-card rounded-2xl overflow-hidden premium-shadow">
            <table class="w-full text-left">
                <thead class="bg-slate-50 text-slate-500 text-xs font-bold uppercase border-b border-slate-200">
                    <tr>
                        <th class="px-6 py-4">Medicine Name</th>
                        <th class="px-6 py-4">Unit & Category</th>
                        <th class="px-6 py-4 text-right">Price (₹)</th>
                        <th class="px-6 py-4 text-center">Stock</th>
                        <th class="px-6 py-4 text-center">Expiry</th>
                        <th class="px-6 py-4 text-right">Actions</th>
                    </tr>
                </thead>
                <tbody id="desktopTableBody" class="divide-y divide-slate-100"></tbody>
            </table>
        </div>

        <div id="mobileCardGrid" class="md:hidden grid grid-cols-1 gap-4"></div>
        <div id="noData" class="hidden py-20 text-center">
            <i class="fas fa-box-open text-slate-400 text-3xl mb-4"></i>
            <p class="text-slate-500">Inventory is empty.</p>
        </div>
    </main>

    <!-- Mobile Action Bar -->
    <div class="fixed bottom-0 left-0 right-0 bg-white border-t border-slate-200 p-4 flex md:hidden gap-3 z-40 premium-shadow">
        <button onclick="openModal('medicineModal')" class="flex-1 bg-blue-600 text-white py-3.5 rounded-xl font-bold flex items-center justify-center gap-2"><i class="fas fa-plus"></i> Add</button>
        <button onclick="openModal('salesModal')" class="flex-1 bg-slate-900 text-white py-3.5 rounded-xl font-bold flex items-center justify-center gap-2"><i class="fas fa-shopping-cart"></i> Sale</button>
    </div>

    <!-- Modals Overlay -->
    <div id="modalOverlay" class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-[60] hidden transition-opacity" onclick="closeAllModals()"></div>

    <!-- Medicine Modal -->
    <div id="medicineModal" class="fixed inset-x-0 bottom-0 md:inset-0 md:flex md:items-center md:justify-center z-[70] hidden p-4">
        <div class="bg-white w-full max-w-lg rounded-t-3xl md:rounded-2xl shadow-2xl overflow-hidden max-h-[95vh] flex flex-col">
            <div class="p-6 bg-blue-600 text-white flex justify-between items-center">
                <h3 id="medModalTitle" class="text-xl font-bold">Stock Entry</h3>
                <button onclick="closeModal('medicineModal')" class="w-10 h-10 flex items-center justify-center rounded-full hover:bg-white/20"><i class="fas fa-times"></i></button>
            </div>
            <form id="medForm" class="p-6 space-y-4 overflow-y-auto">
                <input type="hidden" id="editIndex">
                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Name</label>
                    <input type="text" id="medName" required class="w-full px-4 py-3 bg-slate-50 border rounded-xl outline-none">
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Category</label>
                        <select id="medCategory" class="w-full px-4 py-3 bg-slate-50 border rounded-xl">
                            <option>Mother Tincture</option><option>Dilution</option><option>Trituration</option><option>Biochemic</option><option>Patent</option><option>Liquid</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Unit</label>
                        <select id="medUnit" class="w-full px-4 py-3 bg-slate-50 border rounded-xl">
                            <option value="pcs">Pieces</option><option value="ml">ml</option><option value="l">Litre</option><option value="g">gram</option>
                        </select>
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Type/Power</label>
                        <input type="text" id="medType" class="w-full px-4 py-3 bg-slate-50 border rounded-xl outline-none">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Expiry</label>
                        <input type="date" id="medExpiry" required class="w-full px-4 py-3 bg-slate-50 border rounded-xl outline-none">
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Buying Price (₹)</label>
                        <input type="number" step="0.01" id="medBuyPrice" required class="w-full px-4 py-3 bg-slate-50 border rounded-xl outline-none">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Selling Price (₹)</label>
                        <input type="number" step="0.01" id="medSellPrice" required class="w-full px-4 py-3 bg-slate-50 border rounded-xl outline-none">
                    </div>
                </div>
                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Quantity</label>
                    <input type="number" id="medStock" required class="w-full px-4 py-3 bg-slate-50 border rounded-xl outline-none">
                </div>
                <button type="submit" class="w-full bg-blue-600 text-white font-bold py-4 rounded-xl">Save Stock</button>
            </form>
        </div>
    </div>

    <!-- Sale Modal -->
    <div id="salesModal" class="fixed inset-x-0 bottom-0 md:inset-0 md:flex md:items-center md:justify-center z-[70] hidden p-4">
        <div class="bg-white w-full max-w-lg rounded-t-3xl md:rounded-2xl shadow-2xl overflow-hidden flex flex-col">
            <div class="p-6 bg-slate-900 text-white flex justify-between items-center">
                <h3 class="text-xl font-bold">Record Sale</h3>
                <button onclick="closeModal('salesModal')" class="w-10 h-10 flex items-center justify-center rounded-full hover:bg-white/20"><i class="fas fa-times"></i></button>
            </div>
            <form id="salesForm" class="p-6 space-y-4">
                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Date</label>
                    <input type="date" id="saleDate" required class="w-full px-4 py-3 bg-slate-50 border rounded-xl outline-none">
                </div>
                <div class="relative">
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Search Medicine</label>
                    <input type="text" id="saleMedSearch" placeholder="Start typing..." class="w-full px-4 py-3 bg-slate-50 border rounded-xl outline-none" oninput="filterSaleMedicines()" autocomplete="off">
                    <input type="hidden" id="selectedMedId" required>
                    <div id="saleSearchResults" class="hidden absolute top-full left-0 right-0 bg-white border rounded-xl mt-1 premium-shadow search-results-container"></div>
                </div>
                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Quantity Sold <span id="saleUnitDisplay" class="text-blue-600"></span></label>
                    <input type="number" id="saleQty" value="1" min="1" required class="w-full px-4 py-3 bg-slate-50 border rounded-xl outline-none">
                </div>
                <div class="p-4 bg-slate-50 rounded-2xl border border-slate-200">
                    <div class="flex items-center justify-between mb-2">
                        <span class="text-xs font-bold text-slate-500 uppercase tracking-widest">Fixed MRP?</span>
                        <input type="checkbox" id="useStockPrice" checked onchange="toggleSalePriceField()" class="w-6 h-6 rounded text-blue-600 cursor-pointer">
                    </div>
                    <div id="customPriceDiv" class="hidden mb-2">
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Selling Price (₹ / unit)</label>
                        <input type="number" step="0.01" id="customSellPrice" class="w-full px-4 py-3 bg-white border rounded-xl outline-none">
                    </div>
                    <div id="priceIndicator" class="text-xs text-slate-500 font-bold bg-white px-3 py-2 rounded-lg border italic">Select medicine...</div>
                </div>
                <button type="submit" id="saleSubmitBtn" class="w-full bg-slate-900 text-white font-bold py-4 rounded-xl flex items-center justify-center gap-2"><i class="fas fa-check-circle"></i> Submit Sale</button>
            </form>
        </div>
    </div>

    <!-- Notifications -->
    <div id="toast" class="fixed top-6 right-6 left-6 md:left-auto md:w-80 z-[100] transform -translate-y-20 opacity-0 transition-all duration-300 bg-slate-800 text-white p-4 rounded-2xl shadow-2xl flex items-center gap-3">
        <div id="toastIcon" class="w-10 h-10 rounded-full flex items-center justify-center shrink-0"></div>
        <p id="toastMsg" class="text-sm font-semibold"></p>
    </div>

    <iframe name="hidden_iframe" id="hidden_iframe" class="hidden"></iframe>

    <script>
        const STORAGE_KEY = 'avijit_pharma_stock_v2.9';
        const GOOGLE_FORM_URL = "https://docs.google.com/forms/d/e/1FAIpQLSf8xYihWDT3c5L6F_X9CYUyPC0_U_mIMUVJsowog7Fkx13JHg/formResponse";
        let inventory = JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];

        function toggleSideMenu(isOpen) {
            const menu = document.getElementById('sideMenu');
            const overlay = document.getElementById('sideMenuOverlay');
            if (isOpen) { menu.classList.add('open'); overlay.classList.remove('hidden'); document.body.style.overflow = 'hidden'; }
            else { menu.classList.remove('open'); overlay.classList.add('hidden'); document.body.style.overflow = 'auto'; }
        }

        function saveToStorage() {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(inventory));
            renderInventory();
            updateStats();
        }

        function getExpiryStatus(dateStr) {
            const today = new Date();
            const exp = new Date(dateStr);
            const diffDays = Math.ceil((exp - today) / (1000 * 60 * 60 * 24));
            if (diffDays < 0) return 'expired';
            if (diffDays <= 30) return 'near';
            return 'healthy';
        }

        function renderInventory() {
            const search = document.getElementById('searchInput').value.toLowerCase();
            const cat = document.getElementById('categoryFilter').value;
            const filtered = inventory.filter(m => (m.name.toLowerCase().includes(search)) && (cat === "All" || m.category === cat));

            const desktop = document.getElementById('desktopTableBody');
            const mobile = document.getElementById('mobileCardGrid');
            const noData = document.getElementById('noData');
            document.getElementById('resultCount').textContent = `${filtered.length} items`;

            if (filtered.length === 0) { desktop.innerHTML = ''; mobile.innerHTML = ''; noData.classList.remove('hidden'); }
            else {
                noData.classList.add('hidden');
                desktop.innerHTML = filtered.map(med => {
                    const idx = inventory.findIndex(i => i.id === med.id);
                    const low = med.stock <= 5;
                    const expStatus = getExpiryStatus(med.expiryDate);
                    const expCol = expStatus === 'expired' ? 'text-red-600 font-bold' : (expStatus === 'near' ? 'text-orange-500 font-bold' : 'text-slate-500');
                    return `<tr class="hover:bg-slate-50">
                        <td class="px-6 py-5"><div class="font-bold text-slate-900">${med.name}</div><div class="text-[10px] text-slate-400 font-mono">${med.id}</div></td>
                        <td class="px-6 py-5"><span class="bg-blue-50 text-blue-700 text-[10px] font-bold px-2 py-0.5 rounded uppercase">${med.category}</span><div class="text-[10px] text-slate-500 mt-1">${med.type} (${med.unit})</div></td>
                        <td class="px-6 py-5 text-right font-bold text-slate-700">₹${med.sellPrice}/${med.unit}</td>
                        <td class="px-6 py-5 text-center"><span class="${low ? 'low-stock-pulse' : 'font-bold text-slate-900'} text-lg">${med.stock}</span> <span class="text-xs text-slate-400">${med.unit}</span></td>
                        <td class="px-6 py-5 text-center ${expCol} text-sm">${new Date(med.expiryDate).toLocaleDateString()}</td>
                        <td class="px-6 py-5 text-right"><div class="flex justify-end gap-2">
                            <button onclick="editMedicine(${idx})" class="p-2 text-blue-600 hover:bg-blue-50 rounded-xl"><i class="fas fa-edit"></i></button>
                            <button onclick="deleteMedicine(${idx})" class="p-2 text-red-600 hover:bg-red-50 rounded-xl"><i class="fas fa-trash"></i></button>
                        </div></td>
                    </tr>`;
                }).join('');

                mobile.innerHTML = filtered.map(med => {
                    const idx = inventory.findIndex(i => i.id === med.id);
                    const low = med.stock <= 5;
                    const expStatus = getExpiryStatus(med.expiryDate);
                    return `<div class="glass-card p-4 rounded-2xl flex flex-col gap-3 relative border-l-4 ${low || expStatus === 'expired' ? 'border-l-red-500' : 'border-l-blue-200'}">
                        <div class="flex justify-between items-start">
                            <div><h4 class="font-bold text-slate-900 text-lg">${med.name}</h4><div class="flex items-center gap-2 mt-1"><span class="bg-blue-100 text-blue-800 text-[9px] font-black px-1.5 py-0.5 rounded uppercase">${med.category}</span></div></div>
                            <div class="text-right font-black text-slate-900">₹${med.sellPrice}/${med.unit}</div>
                        </div>
                        <div class="flex items-center justify-between bg-slate-50 p-2 rounded-xl text-center">
                            <div class="flex-1"><p class="text-[8px] uppercase font-bold text-slate-400">Stock</p><p class="${low ? 'text-red-600 font-bold' : 'font-bold'}">${med.stock} ${med.unit}</p></div>
                            <div class="flex-1 border-l border-slate-200"><p class="text-[8px] uppercase font-bold text-slate-400">Expiry</p><p class="${expStatus === 'expired' ? 'text-red-600 font-black' : (expStatus === 'near' ? 'text-orange-500 font-bold' : 'font-bold')} text-xs">${new Date(med.expiryDate).toLocaleDateString()}</p></div>
                        </div>
                        <button onclick="editMedicine(${idx})" class="py-2.5 bg-blue-50 text-blue-600 rounded-xl text-xs font-bold">Edit Stock</button>
                    </div>`;
                }).join('');
            }
        }

        function updateStats() {
            document.getElementById('totalMeds').textContent = inventory.length;
            const totalVal = inventory.reduce((a, b) => a + (b.sellPrice * b.stock), 0);
            document.getElementById('totalValue').textContent = '₹' + totalVal.toLocaleString('en-IN', {minimumFractionDigits: 2});
            
            const lowCount = inventory.filter(m => m.stock <= 5).length;
            const expCount = inventory.filter(m => getExpiryStatus(m.expiryDate) !== 'healthy').length;
            document.getElementById('lowStockCount').textContent = lowCount;
            document.getElementById('expiryAlertCount').textContent = expCount;
            
            const badge = document.getElementById('notifBadge');
            if (lowCount + expCount > 0) { badge.textContent = lowCount + expCount; badge.classList.remove('hidden'); } else badge.classList.add('hidden');

            const banner = document.getElementById('alertBanner');
            const list = document.getElementById('alertItemsList');
            if (lowCount + expCount > 0) {
                banner.classList.remove('hidden');
                let html = '';
                inventory.filter(m => m.stock <= 5 || getExpiryStatus(m.expiryDate) !== 'healthy').forEach(m => {
                    const idx = inventory.findIndex(i => i.id === m.id);
                    const status = getExpiryStatus(m.expiryDate);
                    const isLow = m.stock <= 5;
                    html += `<div class="bg-white border p-2 rounded-xl flex items-center gap-3 shadow-sm">
                        <div class="flex flex-col"><span class="text-xs font-bold">${m.name}</span>
                        <span class="text-[9px] font-black uppercase ${isLow ? 'text-red-600' : 'text-orange-600'}">${isLow ? 'Low Stock' : status.toUpperCase()}</span></div>
                        <button onclick="editMedicine(${idx})" class="bg-slate-900 text-white text-[9px] font-bold px-3 py-1.5 rounded-lg">MANAGE</button>
                    </div>`;
                });
                list.innerHTML = html;
            } else banner.classList.add('hidden');
        }

        function filterSaleMedicines() {
            const query = document.getElementById('saleMedSearch').value.toLowerCase();
            const res = document.getElementById('saleSearchResults');
            if (!query.trim()) { res.classList.add('hidden'); return; }
            const fil = inventory.filter(m => m.name.toLowerCase().includes(query));
            if (fil.length) {
                res.innerHTML = fil.map(m => `<div onclick="selectSaleMedicine('${m.id}', '${m.name}', '${m.unit}')" class="p-3 search-result-item flex justify-between items-center border-b">
                    <div><div class="text-sm font-bold">${m.name}</div><div class="text-[10px] uppercase">${m.category}</div></div>
                    <div class="text-right text-xs font-bold text-blue-600">${m.stock} ${m.unit}</div>
                </div>`).join('');
                res.classList.remove('hidden');
            } else { res.innerHTML = '<div class="p-4 text-xs text-slate-400">No results</div>'; res.classList.remove('hidden'); }
        }

        function selectSaleMedicine(id, name, unit) {
            document.getElementById('selectedMedId').value = id;
            document.getElementById('saleMedSearch').value = name;
            document.getElementById('saleUnitDisplay').textContent = `(Enter number only)`;
            document.getElementById('saleSearchResults').classList.add('hidden');
            updateSalePriceInfo();
        }

        function openModal(id) {
            document.getElementById('modalOverlay').classList.remove('hidden');
            document.getElementById(id).classList.remove('hidden');
            document.body.style.overflow = 'hidden';
            if (id === 'salesModal') document.getElementById('saleDate').valueAsDate = new Date();
        }

        function closeModal(id) {
            document.getElementById('modalOverlay').classList.add('hidden');
            document.getElementById(id).classList.add('hidden');
            document.body.style.overflow = 'auto';
        }

        function closeAllModals() { closeModal('medicineModal'); closeModal('salesModal'); toggleSideMenu(false); }

        document.getElementById('medForm').addEventListener('submit', (e) => {
            e.preventDefault();
            const idx = document.getElementById('editIndex').value;
            const data = {
                id: idx !== "" ? inventory[idx].id : 'AVP-' + Math.random().toString(36).substr(2, 5).toUpperCase(),
                name: document.getElementById('medName').value,
                category: document.getElementById('medCategory').value,
                unit: document.getElementById('medUnit').value,
                type: document.getElementById('medType').value,
                expiryDate: document.getElementById('medExpiry').value,
                buyPrice: parseFloat(document.getElementById('medBuyPrice').value),
                sellPrice: parseFloat(document.getElementById('medSellPrice').value),
                stock: parseInt(document.getElementById('medStock').value)
            };
            if (idx !== "") inventory[idx] = data; else inventory.push(data);
            saveToStorage(); closeAllModals(); showToast("Stock updated", "success");
        });

        function editMedicine(idx) {
            const m = inventory[idx];
            document.getElementById('editIndex').value = idx;
            document.getElementById('medName').value = m.name;
            document.getElementById('medCategory').value = m.category;
            document.getElementById('medUnit').value = m.unit;
            document.getElementById('medType').value = m.type;
            document.getElementById('medExpiry').value = m.expiryDate;
            document.getElementById('medBuyPrice').value = m.buyPrice;
            document.getElementById('medSellPrice').value = m.sellPrice;
            document.getElementById('medStock').value = m.stock;
            openModal('medicineModal');
        }

        function deleteMedicine(idx) {
            if (confirm("Delete this?")) { inventory.splice(idx, 1); saveToStorage(); showToast("Deleted", "info"); }
        }

        function updateSalePriceInfo() {
            const mId = document.getElementById('selectedMedId').value;
            const med = inventory.find(i => i.id === mId);
            const ind = document.getElementById('priceIndicator');
            if (med) {
                ind.innerHTML = `MRP: ₹${med.sellPrice}/${med.unit} | Stock: ${med.stock} ${med.unit}`;
                if (document.getElementById('useStockPrice').checked) document.getElementById('customSellPrice').value = med.sellPrice;
            } else ind.textContent = "Select medicine...";
        }

        function toggleSalePriceField() { document.getElementById('customPriceDiv').classList.toggle('hidden', document.getElementById('useStockPrice').checked); updateSalePriceInfo(); }

        document.getElementById('salesForm').addEventListener('submit', (e) => {
            e.preventDefault();
            const mId = document.getElementById('selectedMedId').value;
            const qty = parseFloat(document.getElementById('saleQty').value);
            if (!mId) { showToast("Select a medicine!", "error"); return; }
            const idx = inventory.findIndex(m => m.id === mId);
            const med = inventory[idx];
            if (med.stock < qty) { showToast("Insufficient stock!", "error"); return; }
            
            const btn = document.getElementById('saleSubmitBtn');
            btn.disabled = true; btn.innerHTML = '<i class="fas fa-sync fa-spin"></i> Processing...';
            
            // MATH: Total Amount
            const unitPrice = document.getElementById('useStockPrice').checked ? med.sellPrice : parseFloat(document.getElementById('customSellPrice').value);
            const totalAmount = (qty * unitPrice).toFixed(2);

            // PAYLOAD: Clean numerical submission
            const pay = new URLSearchParams();
            pay.append('entry.664553955', document.getElementById('saleDate').value);
            pay.append('entry.1352198491', med.name);
            pay.append('entry.385278366', qty); // Numeric only
            pay.append('entry.2088116483', med.buyPrice);
            pay.append('entry.1600120543', totalAmount); // Calculated Total Amount

            const form = document.createElement('form');
            form.action = GOOGLE_FORM_URL; form.method = "POST"; form.target = "hidden_iframe";
            for (const [k, v] of pay) { const i = document.createElement('input'); i.type="hidden"; i.name=k; i.value=v; form.appendChild(i); }
            document.body.appendChild(form); form.submit(); document.body.removeChild(form);

            inventory[idx].stock -= qty;
            saveToStorage();

            setTimeout(() => {
                btn.disabled = false; btn.innerHTML = '<i class="fas fa-check-circle"></i> Submit Sale';
                closeAllModals(); showToast(`Sale of ₹${totalAmount} recorded`, "success");
                document.getElementById('salesForm').reset();
            }, 1000);
        });

        function showToast(m, t) {
            const toast = document.getElementById('toast');
            document.getElementById('toastMsg').textContent = m;
            toast.classList.remove('-translate-y-20', 'opacity-0');
            setTimeout(() => toast.classList.add('-translate-y-20', 'opacity-0'), 3000);
        }

        document.getElementById('searchInput').addEventListener('input', renderInventory);
        document.getElementById('categoryFilter').addEventListener('change', renderInventory);
        renderInventory(); updateStats();
    </script>
</body>
</html>